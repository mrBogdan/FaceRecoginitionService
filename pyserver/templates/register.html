<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Реєстрація</title>
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="main-container">
    <h1>Створення нового акаунта</h1>
    <div id="message" class="message"></div>

    <form id="registerForm">
        <div class="form-group">
            <label for="email">Електронна пошта:</label>
            <input type="email" id="email" name="email" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="password">Пароль:</label>
            <input type="password" id="password" name="password" class="form-control" required>
        </div>

        <div class="form-group">
            <label>Фото обличчя:</label>
            <div class="button-group">
                <button type="button" id="showWebcamBtn" class="btn btn-secondary">Зробити фото</button>
                <button type="button" id="showUploadBtn" class="btn btn-secondary">Завантажити файл</button>
            </div>
        </div>

        <div id="webcam-section" style="display: none;">
            <div class="video-capture-container">
                <video id="webcam" autoplay playsinline></video>
                <div id="oval-overlay" class="oval-overlay"></div>
            </div>
            <button type="button" id="snapButton" class="btn btn-primary">Зробити знімок</button>
        </div>

        <div id="upload-section" style="display: none;">
            <div class="form-group">
                <input type="file" id="face_image_upload" class="form-control" accept="image/*">
            </div>
        </div>

        <div id="image-confirmation" style="display: none; margin-top: 15px;">
            <p style="color: var(--success-color); font-weight: 500;">✓ Фото готове для реєстрації</p>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary" style="margin-top: 20px;">Зареєструватися</button>
    </form>

    <div class="navigation-link">
        <p>Вже є акаунт? <a href="/login">Увійти</a></p>
    </div>
</div>
<canvas id="canvas"></canvas>

<script>
    const registerForm = document.getElementById('registerForm');
    const messageDiv = document.getElementById('message');

    const showWebcamBtn = document.getElementById('showWebcamBtn');
    const showUploadBtn = document.getElementById('showUploadBtn');

    const webcamSection = document.getElementById('webcam-section');
    const uploadSection = document.getElementById('upload-section');

    const webcam = document.getElementById('webcam');
    const snapButton = document.getElementById('snapButton');
    const faceImageUpload = document.getElementById('face_image_upload');
    const ovalOverlay = document.getElementById('oval-overlay');

    const imageConfirmation = document.getElementById('image-confirmation');
    const canvas = document.getElementById('canvas');

    let imageBlob = null;

    function showMessage(msg, type) {
        messageDiv.textContent = msg;
        messageDiv.className = `message ${type}`;
    }

    async function startWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcam.srcObject = stream;
        } catch (err) {
            showMessage('Не вдалося отримати доступ до веб-камери.', 'error');
        }
    }

    function stopWebcam() {
        if (webcam.srcObject) {
            webcam.srcObject.getTracks().forEach(track => track.stop());
        }
    }

    showWebcamBtn.addEventListener('click', () => {
        webcamSection.style.display = 'block';
        uploadSection.style.display = 'none';
        imageConfirmation.style.display = 'none';
        imageBlob = null;
        startWebcam();
    });

    showUploadBtn.addEventListener('click', () => {
        webcamSection.style.display = 'none';
        uploadSection.style.display = 'block';
        imageConfirmation.style.display = 'none';
        imageBlob = null;
        stopWebcam();
    });

    snapButton.addEventListener('click', () => {
        ovalOverlay.classList.add('flash');
        setTimeout(() => ovalOverlay.classList.remove('flash'), 500);

        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(webcam, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            imageBlob = blob;
            imageConfirmation.style.display = 'block';
        }, 'image/jpeg');

        stopWebcam();
    });

    faceImageUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            imageBlob = file;
            imageConfirmation.style.display = 'block';
        }
    });

    registerForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        if (!imageBlob) {
            showMessage('Будь ласка, зробіть фото або завантажте файл.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('email', document.getElementById('email').value);
        formData.append('password', document.getElementById('password').value);
        formData.append('face_image', imageBlob, 'face.jpg');

        showMessage('', '');

        try {
            const response = await fetch('/register', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showMessage('Реєстрація успішна! Вас буде перенаправлено на сторінку входу.', 'success');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showMessage(result.detail || 'Помилка реєстрації.', 'error');
            }
        } catch (error) {
            showMessage('Під час реєстрації сталася непередбачена помилка.', 'error');
        }
    });
</script>
</body>
</html>
