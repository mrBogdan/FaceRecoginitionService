<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вхід</title>
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="main-container">
    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="loader"></div>
        <p>Ідентифікація...</p>
    </div>

    <h1>Вхід у ваш акаунт</h1>
    <div id="message" class="message"></div>

    <div class="button-group">
        <button id="showBiometricBtn" class="btn btn-secondary">Використати веб-камеру</button>
        <button id="showPasswordBtn" class="btn btn-secondary">Використати пароль</button>
    </div>

    <div id="biometric-section">
        <div class="video-capture-container">
            <video id="webcam" autoplay playsinline></video>
            <div id="oval-overlay" class="oval-overlay"></div>
        </div>
        <button id="snapButton" class="btn btn-primary">Сканувати обличчя</button>
    </div>

    <div id="password-section" style="display: none;">
        <form id="passwordLoginForm">
            <div class="form-group">
                <label for="email">Електронна пошта:</label>
                <input type="email" id="email" name="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Пароль:</label>
                <input type="password" id="password" name="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Увійти</button>
        </form>
    </div>

    <div class="navigation-link">
        <p>Немає акаунту? <a href="/register">Зареєструватися</a></p>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
    const biometricSection = document.getElementById('biometric-section');
    const passwordSection = document.getElementById('password-section');
    const showBiometricBtn = document.getElementById('showBiometricBtn');
    const showPasswordBtn = document.getElementById('showPasswordBtn');
    const messageDiv = document.getElementById('message');
    const loaderOverlay = document.getElementById('loader-overlay');
    const webcam = document.getElementById('webcam');
    const ovalOverlay = document.getElementById('oval-overlay');
    const canvas = document.getElementById('canvas');
    const UI_DELAY = 1500;

    function showMessage(msg, type) {
        messageDiv.textContent = msg;
        messageDiv.className = `message ${type}`;
    }

    function toggleLoader(show) {
        loaderOverlay.classList.toggle('hidden', !show);
    }

    async function startWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcam.srcObject = stream;
        } catch (err) {
            showMessage('Не вдалося отримати доступ до веб-камери. Перевірте дозволи.', 'error');
        }
    }

    function stopWebcam() {
        if (webcam.srcObject) {
            webcam.srcObject.getTracks().forEach(track => track.stop());
        }
    }

    showBiometricBtn.addEventListener('click', () => {
        biometricSection.style.display = 'block';
        passwordSection.style.display = 'none';
        startWebcam();
    });

    showPasswordBtn.addEventListener('click', () => {
        biometricSection.style.display = 'none';
        passwordSection.style.display = 'block';
        stopWebcam();
    });

    biometricSection.style.display = 'block';
    passwordSection.style.display = 'none';
    startWebcam();

    document.getElementById('passwordLoginForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        formData.append('type', 'password');

        toggleLoader(true);
        showMessage('', '');

        setTimeout(async () => {
            try {
                const response = await fetch('/token', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('accessToken', result.access_token);
                    window.location.href = '/cabinet';
                } else {
                    showMessage(result.detail || 'Помилка входу. Перевірте дані.', 'error');
                }
            } catch (error) {
                showMessage('Під час входу сталася непередбачена помилка.', 'error');
            } finally {
                toggleLoader(false);
            }
        }, UI_DELAY);
    });

    async function handleBiometricLogin(blob) {
        const formData = new FormData();
        formData.append('type', 'biometric');
        formData.append('image', blob, 'snapshot.jpg');

        toggleLoader(true);
        showMessage('', '');

        setTimeout(async () => {
            try {
                const response = await fetch('/token', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('accessToken', result.access_token);
                    window.location.href = '/cabinet';
                } else {
                    showMessage(result.detail || 'Помилка біометричного входу.', 'error');
                }
            } catch (error) {
                showMessage('Під час біометричного входу сталася помилка.', 'error');
            } finally {
                toggleLoader(false);
            }
        }, UI_DELAY);
    }

    document.getElementById('snapButton').addEventListener('click', async () => {
        ovalOverlay.classList.add('flash');
        setTimeout(() => ovalOverlay.classList.remove('flash'), 500);

        const blob = await captureFrameAsBlob();
        if (blob) {
            handleBiometricLogin(blob);
        }
    });

    function captureFrameAsBlob() {
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(webcam, 0, 0, canvas.width, canvas.height);

        return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
    }
</script>
</body>
</html>
